<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#372F2C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Details ‚Äì AS26 Live</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/img/icon-192.png">
    <link rel="apple-touch-icon" href="/img/icon-192.png">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/programm.css">
</head>
<body>
    <header>
        <a href="#" class="back" id="back-link">‚Üê Zur√ºck</a>
        <div class="badge">Details</div>
    </header>
    <a href="/" class="logo-bar">
        <img src="/img/logo-southside.png" alt="Adventure Southside">
        <img src="/img/logo-academy.png" alt="Selbstausbauer Academy">
    </a>

    <main class="detail-content" id="detail-content">
        <div class="loading" id="detail-loading">Details werden geladen‚Ä¶</div>
    </main>

    <footer>
        <a href="/"><img src="/img/logo-southside.png" alt="" class="footer-logo"></a>
        <p>Adventure Southside 2026</p>
        <p>
            <a href="/impressum.html">Impressum & Datenschutz</a>
            &nbsp;¬∑&nbsp;
            <a href="/faq.html">FAQ & Hilfe</a>
        </p>
    </footer>

    <script>
    (function() {
        'use strict';

        const API_URL = '/api/workshops.json';
        const STORAGE_KEY = 'as26_favorites';
        let backUrl = null;

        // Workshop-ID aus URL extrahieren: /w/{id}/details
        function getWorkshopId() {
            const match = window.location.pathname.match(/\/w\/([a-f0-9]{32})/);
            return match ? match[1] : null;
        }

        function getFavorites() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
            catch { return []; }
        }

        function toggleFavorite(id) {
            const favs = getFavorites();
            const idx = favs.indexOf(id);
            if (idx > -1) favs.splice(idx, 1);
            else favs.push(id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(favs));
            return favs.includes(id);
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        async function loadDetails() {
            const wsId = getWorkshopId();
            if (!wsId) {
                showError('Workshop-ID nicht gefunden.');
                return;
            }

            // Back-Link setzen (mit Filter-State falls vorhanden)
            const params = new URLSearchParams(location.search);
            backUrl = params.get('back');
            document.getElementById('back-link').href = backUrl || ('/w/' + wsId);

            try {
                const resp = await fetch(API_URL + '?t=' + Date.now());
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();
                const ws = (data.workshops || []).find(w => w.id === wsId);

                if (!ws) {
                    showError('Workshop nicht gefunden (ID: ' + wsId + ', Count: ' + (data.workshops||[]).length + ').');
                    return;
                }

                document.title = ws.title + ' ‚Äì AS26 Live';
                renderDetails(ws);
            } catch (err) {
                console.error('Details-Fehler:', err);
                showError('Details konnten nicht geladen werden.<br><small>' + err.message + '</small>');
            }
        }

        function renderDetails(ws) {
            const container = document.getElementById('detail-content');
            const favs = getFavorites();
            const isFav = favs.includes(ws.id);

            let html = '';

            // Workshop Card (oben)
            html += `<div class="workshop-card">
                <span class="typ-badge">${escapeHtml(ws.typ)}</span>
                <h1>${escapeHtml(ws.title)}</h1>
                <div class="meta-row">
                    ${ws.tag ? `<span class="meta-item">üìÖ ${escapeHtml(ws.tag)}</span>` : ''}
                    ${ws.zeit ? `<span class="meta-item">üïê ${escapeHtml(ws.zeit)}</span>` : ''}
                    ${ws.ort ? `<span class="meta-item">üìç ${escapeHtml(ws.ort)}</span>` : ''}
                </div>
            </div>`;

            // Action Buttons
            html += `<div class="detail-actions">
                <a href="/w/${ws.id}/qa" class="btn btn-primary">üí¨ Frage stellen</a>
                <a href="/w/${ws.id}/ical" class="btn btn-secondary">üìÖ Kalender</a>
                <button class="btn btn-secondary fav-toggle" id="fav-toggle" data-id="${ws.id}">
                    ${isFav ? '‚ù§Ô∏è Gemerkt' : 'ü§ç Merken'}
                </button>
            </div>`;

            // Page Content
            if (ws.has_content && ws.content_html) {
                html += '<div class="detail-body">' + ws.content_html + '</div>';
            } else {
                html += '<div class="empty">Keine weiteren Details verf√ºgbar.</div>';
            }

            // Aussteller-Sektion (verlinkt auf Aussteller-Seite mit Standplan)
            if (ws.aussteller && ws.aussteller.length > 0) {
                html += '<div class="detail-aussteller">';
                html += '<h3 style="font-size:.9rem;color:var(--text-light);margin-bottom:.5rem">üìç Aussteller</h3>';
                for (const a of ws.aussteller) {
                    const standBadge = a.stand ? `<span class="aussteller-card-stand" style="font-size:.7rem;padding:.15rem .4rem">${escapeHtml(a.stand)}</span>` : '';
                    const hasCoords = a.stand_x != null && a.stand_y != null;
                    const mapHint = hasCoords ? ' ¬∑ Standort auf Karte' : '';
                    html += `<a href="/aussteller.html#id=${a.id}" class="detail-aussteller-link" style="display:flex;align-items:center;gap:.5rem;padding:.6rem .8rem;margin-bottom:.4rem;background:var(--card);border-radius:var(--radius);border:1px solid var(--border);text-decoration:none;color:var(--text);transition:border-color .2s">
                        <div style="flex:1;min-width:0">
                            <div style="font-weight:700;color:var(--as-braun-dark)">${escapeHtml(a.firma)}</div>
                            <div style="font-size:.75rem;color:var(--text-light)">${standBadge}${mapHint}</div>
                        </div>
                        <span style="color:var(--text-light);font-size:1.1rem">‚Ä∫</span>
                    </a>`;
                }
                html += '</div>';
            }

            // Zur√ºck zum Programm
            const programmBackUrl = backUrl || '/programm.html';
            html += `<div style="margin-top:2rem;text-align:center">
                <a href="${programmBackUrl}" class="btn btn-secondary">üìã Zum Programm</a>
            </div>`;

            container.innerHTML = html;

            // Fav-Toggle Event
            const favBtn = document.getElementById('fav-toggle');
            if (favBtn) {
                favBtn.addEventListener('click', () => {
                    const isNow = toggleFavorite(ws.id);
                    favBtn.innerHTML = isNow ? '‚ù§Ô∏è Gemerkt' : 'ü§ç Merken';
                });
            }
        }

        function showError(msg) {
            document.getElementById('detail-content').innerHTML =
                `<div class="empty">${msg}</div>`;
        }

        document.addEventListener('DOMContentLoaded', loadDetails);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js');
        }
    })();
    </script>
</body>
</html>
