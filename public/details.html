<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#372F2C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Details â€“ AS26 Live</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/img/icon-192.png">
    <link rel="apple-touch-icon" href="/img/icon-192.png">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/programm.css">
    <script src="/js/ortmap.js" defer></script>
</head>
<body>
    <header>
        <a href="#" class="back" id="back-link">â† ZurÃ¼ck</a>
        <div class="badge">Details</div>
    </header>
    <a href="/" class="logo-bar">
        <img src="/img/logo-southside.png" alt="Adventure Southside">
        <img src="/img/logo-academy.png" alt="Selbstausbauer Academy">
    </a>

    <main class="detail-content" id="detail-content">
        <div class="loading" id="detail-loading">Details werden geladenâ€¦</div>
    </main>

    <footer>
        <a href="/"><img src="/img/logo-southside.png" alt="" class="footer-logo"></a>
        <p>Adventure Southside 2026</p>
        <div class="footer-cta-row">
            <a href="https://adventuresouthside.com/" target="_blank" rel="noopener" class="ticket-btn">ğŸ« Ticket sichern</a>
            <button class="share-btn" onclick="(function(){var d={title:'AS26 Live â€“ Dein Messe-Begleiter',text:'Schau dir die Selbstausbauer Academy auf der Adventure Southside 2026 an! Workshops, Experten & Standplan â€“ alles in einer App:',url:'https://as26.cool-camp.site'};if(navigator.share){navigator.share(d).catch(function(){})}else{window.location.href='mailto:?subject='+encodeURIComponent(d.title)+'&body='+encodeURIComponent(d.text+'\n\n'+d.url)}})()"><svg style="vertical-align:middle;margin-right:.3rem" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M14 9V3l8 9-8 9v-6c-7.1 0-11.7 2.1-14.6 7C.8 15.3 4.2 10.1 14 9z"/></svg>Freunden empfehlen</button>
        </div>
        <p>
            <a href="/impressum.html">Impressum & Datenschutz</a>
            &nbsp;Â·&nbsp;
            <a href="/faq.html">FAQ & Hilfe</a>
        </p>
    </footer>

    <script>
    (function() {
        'use strict';

        const API_URL = '/api/workshops.json';
        const STORAGE_KEY = 'as26_favorites';
        let backUrl = null;

        // Workshop-ID aus URL extrahieren: /w/{id}/details
        function getWorkshopId() {
            const match = window.location.pathname.match(/\/w\/([a-f0-9]{32})/);
            return match ? match[1] : null;
        }

        function getFavorites() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
            catch { return []; }
        }

        function toggleFavorite(id) {
            const favs = getFavorites();
            const idx = favs.indexOf(id);
            if (idx > -1) favs.splice(idx, 1);
            else favs.push(id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(favs));
            return favs.includes(id);
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /**
         * Rendert Referent + Firma unterhalb der Meta-Zeile im Workshop-Card.
         * Firma ist anklickbar wenn der Aussteller existiert â†’ Ã¶ffnet Standplan.
         */
        function renderReferentFirma(ws) {
            const persons = ws.referent_persons || [];
            const firmaText = ws.referent_firma || '';
            const aussteller = ws.aussteller || [];

            if (persons.length === 0 && !firmaText && aussteller.length === 0) return '';

            let html = '<div style="margin-top:.6rem;font-size:.85rem;color:var(--text-light)">';

            // Referent Person(en) â€“ verlinkt zur Experten-Seite
            if (persons.length > 0) {
                const personLinks = persons.map(p =>
                    `<a href="/experte.html#id=${p.id}" style="color:var(--text-light);text-decoration:underline;text-decoration-color:var(--as-rot);text-underline-offset:2px">${escapeHtml(p.name)}</a>`
                ).join(', ');
                html += `<span>ğŸ¤ ${personLinks}</span>`;
            }

            // Firma(s): Aussteller-Links haben Vorrang, dann referent_firma als Fallback
            if (aussteller.length > 0) {
                const links = aussteller.map(a => {
                    if (a.stand) {
                      return `<span data-show-stand="${escapeHtml(a.stand)}" data-firma="${escapeHtml(a.firma)}">ğŸª ${escapeHtml(a.firma)} [Stand ${escapeHtml(a.stand)}]</span>`;
                    }
                    return `<span>ğŸª ${escapeHtml(a.firma)}</span>`;
                });
                html += `<div style="margin-top:.35rem">${links.join(', ')}</div>`;
            } else if (firmaText) {
                html += `<div style="margin-top:.35rem">${escapeHtml(firmaText)}</div>`;
            }

            html += '</div>';
            return html;
        }

        async function loadDetails() {
            const wsId = getWorkshopId();
            if (!wsId) {
                showError('Workshop-ID nicht gefunden.');
                return;
            }

            // Back-Link setzen (mit Filter-State falls vorhanden)
            const params = new URLSearchParams(location.search);
            backUrl = params.get('back');
            document.getElementById('back-link').href = backUrl || ('/w/' + wsId);

            try {
                const resp = await fetch(API_URL + '?t=' + Date.now());
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();
                const ws = (data.workshops || []).find(w => w.id === wsId);

                if (!ws) {
                    showError('Workshop nicht gefunden (ID: ' + wsId + ', Count: ' + (data.workshops||[]).length + ').');
                    return;
                }

                document.title = ws.title + ' â€“ AS26 Live';
                renderDetails(ws);
            } catch (err) {
                console.error('Details-Fehler:', err);
                showError('Details konnten nicht geladen werden.<br><small>' + err.message + '</small>');
            }
        }

        function renderDetails(ws) {
            const container = document.getElementById('detail-content');
            const favs = getFavorites();
            const isFav = favs.includes(ws.id);

            let html = '';

            // Workshop Card (oben)
            html += `<div class="workshop-card">
                <span class="typ-badge">${escapeHtml(ws.typ)}</span>
                <h1>${escapeHtml(ws.title)}</h1>
                <div class="meta-row">
                    ${ws.tag ? `<span class="meta-item">ğŸ“… ${escapeHtml(ws.tag)}</span>` : ''}
                    ${ws.zeit ? `<span class="meta-item">ğŸ• ${escapeHtml(ws.zeit)}</span>` : ''}
                    ${ws.ort ? `<span class="meta-item" data-show-ort="${escapeHtml(ws.ort)}">ğŸ“ ${escapeHtml(ws.ort)}</span>` : ''}
                </div>
                ${renderReferentFirma(ws)}
            </div>`;

            // Action Buttons
            html += `<div class="detail-actions">
                <a href="/w/${ws.id}/qa" class="btn btn-primary">ğŸ’¬ Frage stellen</a>
                <a href="/w/${ws.id}/ical" class="btn btn-secondary">ğŸ“… Kalender</a>
                <button class="btn btn-secondary fav-toggle" id="fav-toggle" data-id="${ws.id}">
                    ${isFav ? 'â¤ï¸ Gemerkt' : 'ğŸ¤ Merken'}
                </button>
                <button class="btn btn-secondary" id="share-ws" data-id="${ws.id}" data-title="${escapeHtml(ws.title)}">
                    <svg style="vertical-align:middle;margin-right:.25rem" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M14 9V3l8 9-8 9v-6c-7.1 0-11.7 2.1-14.6 7C.8 15.3 4.2 10.1 14 9z"/></svg>Teilen
                </button>
            </div>`;

            // Page Content
            if (ws.has_content && ws.content_html) {
                html += '<div class="detail-body">' + ws.content_html + '</div>';
            } else {
                html += '<div class="empty">Keine weiteren Details verfÃ¼gbar.</div>';
            }

            // (Referent + Firma wird jetzt im Workshop-Card via renderReferentFirma() gerendert)

            // ZurÃ¼ck-Buttons
            html += `<div style="margin-top:2rem;text-align:center">
                <a href="/programm.html" class="btn btn-secondary">ğŸ“‹ Zum Programm</a>
            </div>`;

            container.innerHTML = html;

            // Fav-Toggle Event
            const favBtn = document.getElementById('fav-toggle');
            if (favBtn) {
                favBtn.addEventListener('click', () => {
                    const isNow = toggleFavorite(ws.id);
                    favBtn.innerHTML = isNow ? 'â¤ï¸ Gemerkt' : 'ğŸ¤ Merken';
                });
            }

            // Share Event
            const shareBtn = document.getElementById('share-ws');
            if (shareBtn) {
                shareBtn.addEventListener('click', () => {
                    const wsId = shareBtn.dataset.id;
                    const wsTitle = shareBtn.dataset.title;
                    const url = location.origin + '/w/' + wsId;
                    const shareData = { title: wsTitle + ' â€“ AS26 Live', text: wsTitle, url: url };
                    if (navigator.share) {
                        navigator.share(shareData).catch(() => {});
                    } else {
                        location.href = 'mailto:?subject=' + encodeURIComponent(shareData.title) + '&body=' + encodeURIComponent(shareData.text + '\n\n' + shareData.url);
                    }
                });
            }
        }

        function showError(msg) {
            document.getElementById('detail-content').innerHTML =
                `<div class="empty">${msg}</div>`;
        }

        document.addEventListener('DOMContentLoaded', loadDetails);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js');
        }
    })();
    </script>
</body>
</html>
